<!DOCTYPE html>
<html>
<head>
  <title>Crypto</title>
  <style>
    a:visited {
      color: blue;
    }

    .status {
      text-align: center;
    }

    .higher {
      color: #ff0066 !important;
    }

    .lower {
      color: green !important;
    }

    .levelTwo,
    .outdated,
    .warning
    {
      color: red !important;
    }

    .gain {
      color: rgb(130, 214, 84) !important;
    }

    .loss {
      color: rgb(237, 87, 72) !important;
    }

    .levelOne {
      color: orange !important;
    }

    .levelThree {
      color: #ff66ff !important;
    }

    .last-updated {
      margin-top: 5px;
    }

    .tooltip {
      border-bottom: 1px dotted black;
      display: inline-block;
      position: relative;
    }

    .tooltip .tooltiptext {
      color: #fff;
      background-color: black;
      border-radius: 6px;
      padding: 5px 0;
      position: absolute;
      text-align: center;
      visibility: hidden;
      width: 120px;
      z-index: 1;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
    }
  </style>
</head>
<body>
  <div>
    <span class="warning">WARNING:</span> Make sure to check the status of the wallet on each exchange before trading. Deposits or withdrawals may be suspended. Also be sure to check the number of buy orders on the exchange you are moving assets into. There may only be a few orders for the price that is being shown. Prices can be delayed, so click the price to get the latest.

    <a target="_blank" href="https://bittrex.com/Balance">Bittrex wallets</a>
    <a target="_blank" href="https://bittrex.com/Status">Bittrex wallet statuses</a>
    <a target="_blank" href="https://www.binance.com/userCenter/depositWithdraw.html">Binance wallets</a>
    <a target="_blank" href="https://www.huobi.pro/finance/">Huobi wallets</a>
    <a target="_blank" href="https://www.kucoin.com/#/user/account/dashboard">Kucoin wallets</a>

  </div>

  <div class="last-updated">
    <b>Prices last updated</b>: <span class="time"></span>
  </div>

  <div class="gdax">
    <ul class="usd-prices">
    </ul>
  </div>

  <table class="crypto">
    <tr>
      <th>Currency</th>
      <th>Change</th>
      <th>Bittrex</th>
      <th>Status</th>
      <th>Binance</th>
      <th>Status</th>
      <th>Coinbase</th>
      <th>Difference</th>
      <th>Huobi</th>
      <th>Status</th>
      <th>Kucoin</th>
      <th>Status</th>
      <th>Difference</th>
    </tr>
  </table>
  <div class="to-do">
    <h2>TO DO:</h2>
    <ul>
      <li>Sorting</li>
      <li>Include coinbase in difference calculation</li>
      <li>Volume of orders for Bittrex</li>
      <li>Optomize notification rules</li>
      <li>Optomize color scheme and appearance</li>
      <li>Use Binance wallet status for determining notifications</li>
      <li>Add wallets</li>
      <li>Add ETH market diffs</li>
      <li>Add USDT market diffs</li>
      <li>Add Kraken</li>
      <li>Automatically generate list of coins shared between exchanges</li>
      <li>Extract out JS from HTML page</li>
      <li>Compute diff with min(ask) - max(bid) instead of last prices</li>
      <li>Show actionable diffs and last price diffs</li>
      <li>Add links to individual withdraw / deposit pages</li>
      <li>Configurable notifications/subscriptions</li>
      <li>Page with all graphs</li>
      <li>Add alerts on hour change (or more granular)</li>
    </ul>
  </div>

  <script>
    let notificationsEnabled = Notification.permission === 'granted';

    if (!notificationsEnabled) {
      const permissionCallback = result => {
        if (result === 'denied') {
          console.log('Permission wasn\'t granted. Allow a retry.');

          return;
        }

        if (result === 'default') {
          console.log('The permission request was dismissed.');

          return;
        }

        notificationsEnabled = true;
      };

      const request = Notification.requestPermission(permissionCallback);

      if (request && 'then' in request) request.then(permissionCallback);
    }

    const usdPrices = document.querySelector('.usd-prices');

    ['BTC', 'BCH', 'ETH', 'LTC'].forEach(currency => {
      const row = document.createElement('li');

      row.classList.add(`${currency}-USD`);

      row.innerHTML = `
        <li>
          <a target="_blank" href="https://www.gdax.com/trade/${currency}-USD">${currency}</a>: <span class="price"></span>
        </li>
      `;

      usdPrices.appendChild(row);
    });

    const CRYPTO = [
      'ADA',
      'ADX',
      'ARK',
      'BAT',
      'BCH',
      'BCPT',
      'BNT',
      'BTG',
      'CLOAK',
      'DASH',
      'DNT',
      'ENG',
      'ETC',
      'ETH',
      'GRS',
      'KMD',
      'LRC',
      'LSK',
      'LTC',
      'LUN',
      'MANA',
      'MCO',
      'NAV',
      'NEO',
      'OMG',
      'POWR',
      'PIVX',
      'QTUM',
      'RCN',
      'RLC',
      'SALT',
      'SNT',
      'STEEM',
      'STORJ',
      'STRAT',
      'SYS',
      'TRX',
      'VIA',
      'VIB',
      'WAVES',
      'WINGS',
      'XEM',
      'XLM',
      'XMR',
      'XRP',
      'XVG',
      'XZC',
      'ZEC',
      'ZRX',
      'APPC',
      'AST',
      'BLZ',
      'BTS',
      'CHAT',
      'CMT',
      'DGD',
      'GNT',
      'ICX',
      'IOTA',
      'LINK',
      'MTL',
      'OST',
      'PRO',
      'SRN',
      'TNB',
      'TNT',
      'WPR',
      'ABT',
      'ACT',
      'AION',
      'AMB',
      'ARN',
      'BCD',
      'BRD',
      'BTM',
      'CVC',
      'DAT',
      'DBC',
      'DGB',
      'DTA',
      'ELF',
      'ENJ',
      'EOS',
      'EVX',
      'GAS',
      'GVT',
      'HSR',
      'INS',
      'IOST',
      'ITC',
      'KNC',
      'LEND',
      'LOOM',
      'MOD',
      'MTH',
      'MTN',
      'NANO',
      'NEBL',
      'NULS',
      'OCN',
      'ONT',
      'PAY',
      'POE',
      'PPT',
      'QLC',
      'QSP',
      'RDN',
      'REQ',
      'RPX',
      'SNC',
      'SNM',
      'STK',
      'SUB',
      'UKG',
      'UTK',
      'VEN',
      'WAN',
      'WAX',
      'WTC',
      'ZIL'
    ];

    const COINMARKETCAP = {
      ABT: 'arcblock',
      ACT: 'achain',
      ADA: 'cardano',
      ADX: 'adx-net',
      AION: 'aion',
      AMB: 'amber',
      APPC: 'appcoins',
      ARK: 'ark',
      ARN: 'aeron',
      AST: 'airswap',
      BAT: 'basic-attention-token',
      BCD: 'bitcoin-diamond',
      BCH: 'bitcoin-cash',
      BCPT: 'blockmason',
      BLZ: 'bluzelle',
      BNT: 'bancor',
      BRD: 'bread',
      BTG: 'bitcoin-gold',
      BTM: 'bytom',
      BTS: 'bitshares',
      CHAT: 'chatcoin',
      CLOAK: 'cloakcoin',
      CMT: 'cybermiles',
      CVC: 'civic',
      DASH: 'dash',
      DAT: 'datum',
      DBC: 'deepbrain-chain',
      DGB: 'digibyte',
      DGD: 'digixdao',
      DNT: 'district0x',
      DOGE: 'dogecoin',
      DTA: 'data',
      ELF: 'aelf',
      ENG: 'enigma-project',
      ENJ: 'enjin-coin',
      EOS: 'eos',
      ETC: 'ethereum-classic',
      EVX: 'everex',
      ETH: 'ethereum',
      GAS: 'gas',
      GNO: 'gnosis-gno',
      GNT: 'golem-network-tokens',
      GRS: 'groestlcoin',
      GVT: 'genesis-vision',
      HSR: 'hshare',
      ICN: 'iconomi',
      ICX: 'icon',
      INS: 'ins-ecosystem',
      IOST: 'iostoken',
      IOTA: 'iota',
      ITC: 'iot-chain',
      KMD: 'komodo',
      KNC: 'kyber-network',
      LEND: 'ethlend',
      LINK: 'chainlink',
      LOOM: 'loom-network',
      LRC: 'loopring',
      LSK: 'lisk',
      LTC: 'litecoin',
      LUN: 'lunyr',
      MANA: 'decentraland',
      MCO: 'monaco',
      MLN: 'melon',
      MOD: 'modum',
      MTH: 'monetha',
      MTL: 'metal',
      MTN: 'medical-chain',
      NANO: 'nano',
      NAV: 'nav-coin',
      NEBL: 'neblio',
      NEO: 'neo',
      NULS: 'nuls',
      OCN: 'odyssey',
      OMG: 'omisego',
      ONT: 'ontology',
      OST: 'ost',
      PAY: 'tenx',
      PIVX: 'pivx',
      POE: 'poet',
      POWR: 'power-ledger',
      PPT: 'populous',
      PRO: 'propy',
      QLC: 'qlink',
      QSP: 'quantstamp',
      QTUM: 'qtum',
      RCN: 'ripio-credit-network',
      RDN: 'raiden-network-token',
      REP: 'augur',
      REQ: 'request-network',
      RLC: 'rlc',
      RPX: 'red-pulse',
      SALT: 'salt',
      SNC: 'suncontract',
      SNM: 'sonm',
      SNT: 'status',
      SRN: 'sirin-labs-token',
      STK: 'stk',
      STORJ: 'storj',
      STRAT: 'stratis',
      STEEM: 'steem',
      SUB: 'substratum',
      SYS: 'syscoin',
      TNB: 'time-new-bank',
      TNT: 'tierion',
      TRX: 'tron',
      UKG: 'unikoin-gold',
      UTK: 'utrust',
      VEN: 'vechain',
      VIA: 'viacoin',
      VIB: 'viberate',
      WAN: 'wanchain',
      WAVES: 'waves',
      WAX: 'wax',
      WINGS: 'wings',
      WPR: 'wepower',
      WTC: 'walton',
      XEM: 'nem',
      XLM: 'stellar',
      XMR: 'monero',
      XRP: 'ripple',
      XVG: 'verge',
      XZC: 'zcoin',
      ZEC: 'zcash',
      ZIL: 'zilliqa',
      ZRX: '0x'
    };

    const DENORMALIZE = { BCH: 'BCC' };
    const TO_LEGACY = { NANO: 'XRB', PRO: 'PROPY' };

    const CRYPTOCOMPARE = CRYPTO.map(currency => TO_LEGACY[currency] ? TO_LEGACY[currency] : currency);

    const EXCHANGES = ['bittrex', 'binance', 'huobi', 'kucoin'];

    const table = document.querySelector('.crypto');

    CRYPTO.forEach(currency => {
      const row = document.createElement('tr');

      row.classList.add(currency);

      const exchangeName = DENORMALIZE[currency] ? DENORMALIZE[currency] : currency;
      const legacyName = TO_LEGACY[currency] ? TO_LEGACY[currency] : currency;

      row.innerHTML = `
        <td class="currency"><a target="_blank" href="https://coinmarketcap.com/currencies/${COINMARKETCAP[currency] || currency}">${currency}</a></td>
        <td class="change"></td>
        <td class="bittrex"><a target="_blank" href="https://bittrex.com/Market/Index?MarketName=BTC-${exchangeName}"></a></td>
        <td class="bittrex-status status"></td>
        <td class="binance"><a target="_blank" href="https://www.binance.com/trade.html?symbol=${exchangeName}_BTC"></a></td>
        <td class="binance-status status"></td>
        <td class="coinbase"><a target="_blank" href="https://www.gdax.com/trade/${currency}-BTC"></a></td>
        <td class="difference"></td>
        <td class="huobi"><a target="_blank" href="https://www.huobi.pro/${legacyName.toLowerCase()}_btc/exchange/"></a></td>
        <td class="huobi-status status"></td>
        <td class="kucoin"><a target="_blank" href="https://www.kucoin.com/#/trade.pro/${legacyName}-BTC"></a></td>
        <td class="kucoin-status status"></td>
        <td class="difference-all"><a target="_blank"></a></td>
      `;

      table.appendChild(row);
    });

    const MILLISECOND = 1;
    const SECOND = 1000 * MILLISECOND;
    const MINUTE = 60 * SECOND;
    const HOUR = 60 * MINUTE;

    function getCoinbasePrices() {
      const exchangePrices = CRYPTO.reduce((prices, currency) => {
        prices[currency] = {};

        return prices;
      }, {});

      exchangePrices.BTC = {};

      Promise.all(
        ['BTC', 'BCH', 'ETH', 'LTC'].reduce((promises, currency) => {
          promises.push(
            fetch(`https://api.gdax.com/products/${currency}-USD/ticker`)
              .then(response => response.json())
              .then(ticker => {
                const price = Number(Number(ticker.price).toFixed(2));

                document.querySelector(`.${currency}-USD .price`).textContent = `$${price}`;

                if (currency !== 'BTC') return;

                exchangePrices[currency].coinbase = price;
              })
          )

          if (currency === 'BTC') return promises;

          promises.push(
            fetch(`https://api.gdax.com/products/${currency}-BTC/ticker`)
              .then(response => response.json())
              .then(ticker => {
                const price = Number(ticker.price);
                const entry = document.querySelector(`.${currency} .coinbase a`);

                entry.textContent = price;
                exchangePrices[currency].coinbase = price;
              })
          )

          return promises
        }, [])
      ).then(() => {
        document.title = `$${exchangePrices.BTC.coinbase}`;

        setTimeout(getCoinbasePrices, SECOND);
      }).catch(() => {
        setTimeout(getCoinbasePrices, 2 * SECOND);
      });
    }

    function getChanges() {
      const half = Math.floor(CRYPTOCOMPARE.length / 2);
      const firstHalf = CRYPTOCOMPARE.slice(0, half).join();
      const secondHalf = CRYPTOCOMPARE.slice(half).join();

      return Promise.all([
        fetch(`https://min-api.cryptocompare.com/data/pricemultifull?fsyms=${firstHalf}&tsyms=BTC`)
          .then(response => response.json())
          .then(({ RAW: prices }) => prices),
        fetch(`https://min-api.cryptocompare.com/data/pricemultifull?fsyms=${secondHalf}&tsyms=BTC`)
          .then(response => response.json())
          .then(({ RAW: prices }) => prices)
      ]).then(([firstHalfPrices, secondHalfPrices]) => {
        const prices = Object.assign({}, firstHalfPrices, secondHalfPrices);

        CRYPTO.forEach(currency => {
          const price = prices[TO_LEGACY[currency] ? TO_LEGACY[currency] : currency];

          if (!price) return;

          const change = price.BTC.CHANGEPCT24HOUR;
          const changeEntry = document.querySelector(`.${currency} .change`);

          changeEntry.classList.remove('gain', 'loss');
          changeEntry.classList.add(change > 0 ? 'gain' : 'loss');

          changeEntry.textContent = `${change.toFixed(2)}%`;
        });

        setTimeout(getChanges, 2 * SECOND);
      }).catch(() => {
        setTimeout(getChanges, 3 * SECOND);
      });
    }

    function createTooltip(toggle, text) {
      const tooltip = document.createElement('div');

      tooltip.classList.add('tooltip');
      tooltip.textContent = toggle;

      const tooltipText = document.createElement('span');

      tooltipText.classList.add('tooltiptext');
      tooltipText.textContent = text;

      tooltip.appendChild(tooltipText);

      return tooltip;
    }

    function getPrices() {
      fetch('https://crypto-191318.appspot.com/crypto?arbitrage=true')
        .then(response => response.json())
        .then(prices => {
          const notifications = [];

          CRYPTO.forEach(currency => {
            EXCHANGES.forEach(exchange => {
              const market = prices[currency][exchange];

              if (!market) return;

              const priceEntry = document.querySelector(`.${currency} .${exchange} a`);
              const price = market.last;

              priceEntry.innerHTML = '';

              priceEntry.appendChild(
                createTooltip(
                  price,
                  `
                    Bid: ${market.bid},
                    Ask: ${market.ask},
                    Confirmations: ${market.confirmations}
                  `
                )
              );

              const statusEntry = document.querySelector(`.${currency} .${exchange}-status`);

              statusEntry.innerHTML = '';

              if (market.marketActive && market.depositsEnabled && market.withdrawalsEnabled) return;

              statusEntry.appendChild(
                createTooltip(
                  '!!!',
                  `
                    Deposits: ${market.depositsEnabled},
                    Withdrawals: ${market.withdrawalsEnabled},
                    Notice: ${market.notice}
                  `
                )
              );
            });

            const bittrexEntry = document.querySelector(`.${currency} .bittrex a`);
            const binanceEntry = document.querySelector(`.${currency} .binance a`);
            const huobiEntry = document.querySelector(`.${currency} .huobi a`);
            const kucoinEntry = document.querySelector(`.${currency} .kucoin a`);

            [
              bittrexEntry,
              binanceEntry,
              huobiEntry,
              kucoinEntry
            ].forEach(entry => entry.classList.remove('higher', 'lower'));

            const exchangeDifferences = EXCHANGES.reduce((differences, buyFrom) => {
              const buyMarket = prices[currency][buyFrom];

              if (!buyMarket || !buyMarket.withdrawalsEnabled) return differences;

              EXCHANGES.forEach(sellAt => {
                if (buyFrom === sellAt) return;

                const sellMarket = prices[currency][sellAt];

                if (!sellMarket || !sellMarket.depositsEnabled) return;

                differences.push({
                  buy: buyFrom,
                  sell: sellAt,
                  bid: sellMarket.bid,
                  ask: buyMarket.ask,
                  difference: sellMarket.bid - buyMarket.ask
                });
              });

              return differences;
            }, []).sort((a, b) => {
              if (a.difference < b.difference) return -1;
              if (a.difference > b.difference) return 1;

              return 0;
            });

            if (exchangeDifferences.length > 0) {
              const differenceEntry = document.querySelector(`.${currency} .difference-all a`);
              const greatest = exchangeDifferences[exchangeDifferences.length - 1];
              const percentage = greatest.difference / greatest.bid * 100;

              differenceEntry.classList.remove('levelOne', 'levelTwo', 'levelThree');
              differenceEntry.innerHTML = '';

              differenceEntry.appendChild(
                createTooltip(
                  `${percentage.toFixed(2)}%`,
                  `
                    Buy from: ${greatest.buy},
                    Sell at: ${greatest.sell}
                  `
                )
              );

              const exchangeName = DENORMALIZE[currency] ? DENORMALIZE[currency] : currency;
              const legacyName = TO_LEGACY[currency] ? TO_LEGACY[currency] : currency;

              let exchangeUrl;

              switch (greatest.buy) {
                case 'bittrex':
                  exchangeUrl = `https://bittrex.com/Market/Index?MarketName=BTC-${exchangeName}`;
                  bittrexEntry.classList.add('lower');
                  break;
                case 'binance':
                  exchangeUrl = `https://www.binance.com/trade.html?symbol=${exchangeName}_BTC`;
                  binanceEntry.classList.add('lower');
                  break;
                case 'huobi':
                  exchangeUrl = `https://www.huobi.pro/${legacyName.toLowerCase()}_btc/exchange/`;
                  huobiEntry.classList.add('lower');
                  break;
                case 'kucoin':
                  exchangeUrl = `https://www.kucoin.com/#/trade.pro/${legacyName}-BTC`;
                  kucoinEntry.classList.add('lower');
                  break;
              }

              differenceEntry.href = exchangeUrl;

              switch (greatest.sell) {
                case 'bittrex':
                  bittrexEntry.classList.add('higher');
                  break;
                case 'binance':
                  binanceEntry.classList.add('higher');
                  break;
                case 'huobi':
                  huobiEntry.classList.add('higher');
                  break;
                case 'kucoin':
                  kucoinEntry.classList.add('higher');
                  break;
              }

              if (percentage > 4.5) {
                differenceEntry.classList.add('levelThree');
              } else if (percentage > 3) {
                differenceEntry.classList.add('levelTwo');
              } else if (percentage > 1) {
                differenceEntry.classList.add('levelOne');
              }

              const isKucoin = greatest.buy === 'kucoin' || greatest.sell == 'kucoin';

              if (isKucoin && percentage >= 3 || !isKucoin && percentage >= 1) {
                notifications.push({ currency, percentage: percentage.toFixed(2) });
              }
            }

            const bittrex = prices[currency].bittrex;
            const binance = prices[currency].binance;

            if (!bittrex || !binance) return;

            const differences = {
              binance: bittrex.bid - binance.ask,
              bittrex: binance.bid - bittrex.ask
            };
            let difference;
            let min;

            if (differences.binance > differences.bittrex) {
              bittrexEntry.classList.add('higher');
              binanceEntry.classList.add('lower');

              difference = differences.binance;
              min = binance.ask;
            } else {
              bittrexEntry.classList.add('lower');
              binanceEntry.classList.add('higher');

              difference = differences.bittrex;
              min = bittrex.ask;
            }

            const entry = document.querySelector(`.${currency} .difference`);
            const percentage = difference / min * 100;

            entry.textContent = `${percentage.toFixed(2)}%`;
            entry.classList.remove('levelOne', 'levelTwo', 'levelThree');

            if (percentage > 4.5) {
              entry.classList.add('levelThree');
            } else if (percentage > 3) {
              entry.classList.add('levelTwo');
            } else if (percentage > 1) {
              entry.classList.add('levelOne');
            }
          });

          if (notificationsEnabled && notifications.length > 0) {
            notifications.sort((a, b) => (b.percentage - a.percentage));

            new Notification(
              'Price Alerts',
              {
                body: notifications.map(
                  ({ currency, percentage }) => `${currency}: ${percentage}%`
                ).join('; ')
              }
            );
          }

          const lastUpdatedEntry = document.querySelector('.last-updated .time');
          const lastUpdatedTime = new Date(prices.lastUpdated);

          lastUpdatedEntry.textContent = lastUpdatedTime;

          if (Date.now() - lastUpdatedTime > MINUTE) {
            lastUpdatedEntry.classList.add('outdated');
          } else {
            lastUpdatedEntry.classList.remove('outdated');
          }

          setTimeout(getPrices, SECOND);
        }).catch(error => {
          console.log(error);

          setTimeout(getPrices, 2 * SECOND);
        })
    }

    getCoinbasePrices();
    getChanges();
    getPrices();
  </script>
</body>
</html>
