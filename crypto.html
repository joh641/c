<!DOCTYPE html>
<html>
<head>
  <title>Crypto</title>
  <style>
    a:visited {
      color: blue;
    }

    .higher {
      color: #ff0066 !important;
    }

    .lower {
      color: green !important;
    }

    .levelTwo,
    .warning
    {
      color: red !important;
    }

    .gain {
      color: rgb(130, 214, 84) !important;
    }

    .loss {
      color: rgb(237, 87, 72) !important;
    }

    .levelOne {
      color: orange;
    }

    .levelThree {
      color: #ff66ff;
    }

    .last-updated {
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div>
    <span class="warning">WARNING:</span> Make sure to check the status of the wallet on each exchange before trading. Deposits or withdrawals may be suspended. Also be sure to check the number of buy orders on the exchange you are moving assets into. There may only be a few orders for the price that is being shown. Prices can be delayed, so click the price to get the latest.

    <a target="_blank" href="https://bittrex.com/Balance">Bittrex wallets</a>
    <a target="_blank" href="https://bittrex.com/Status">Bittrex wallet statuses</a>
    <a target="_blank" href="https://www.binance.com/userCenter/depositWithdraw.html">Binance wallets</a>
  </div>

  <div class="last-updated">
    <b>Prices last updated</b>: <span class="time"></span>
  </div>

  <div class="gdax">
    <ul class="usd-prices">
    </ul>
  </div>

  <table class="crypto">
    <tr>
      <th>Currency</th>
      <th>Bittrex</th>
      <th>Binance</th>
      <th>Change</th>
      <th>Coinbase</th>
      <th>Difference</th>
    </tr>
  </table>
  <div class="to-do">
    <h2>TO DO:</h2>
    <ul>
      <li>Sorting</li>
      <li>Include coinbase in difference calculation</li>
      <li>Volume of orders within the difference range</li>
      <li>Send notification when difference reaches certain thresholds</li>
      <li>Optomize color scheme and appearance</li>
      <li>Wallet status, transaction times, number of confirmations required</li>
      <li>Add wallets</li>
    </ul>
  </div>

  <script>
    const usdPrices = document.querySelector('.usd-prices');

    ['BTC', 'BCH', 'ETH', 'LTC'].forEach(currency => {
      const row = document.createElement('li');

      row.classList.add(`${currency}-USD`);

      row.innerHTML = `
        <li>
          <a target="_blank" href="https://www.gdax.com/trade/${currency}-USD">${currency}</a>: <span class="price"></span>
        </li>
      `;

      usdPrices.appendChild(row);

      if (currency === 'BTC' || currency === 'BTC') return;

      fetch(`https://api.gdax.com/products/${currency}-USD/ticker`)
        .then(response => response.json())
        .then(({ price }) => {
          document.querySelector(`.${currency}-USD .price`).textContent = `$${price}`;
        });
    });

    const CRYPTO = [
      'ADA',
      'ADX',
      'ARK',
      'BAT',
      'BCH',
      'BNT',
      'BTG',
      'DASH',
      'DNT',
      'ENG',
      'ETC',
      'ETH',
      'FUN',
      'KMD',
      'LSK',
      'LTC',
      'LUN',
      'MANA',
      'MCO',
      'NAV',
      'NEO',
      'OMG',
      'POWR',
      'QTUM',
      'RCN',
      'RLC',
      'SALT',
      'SNT',
      'STORJ',
      'STRAT',
      'VIB',
      'WAVES',
      'WINGS',
      'XLM',
      'XMR',
      'XRP',
      'XVG',
      'XZC',
      'ZEC'
    ];

    const COINMARKETCAP = {
      ADA: 'cardano',
      ADX: 'adx-net',
      ARK: 'ark',
      BAT: 'basic-attention-token',
      BCH: 'bitcoin-cash',
      BNT: 'bancor',
      BTG: 'bitcoin-gold',
      DASH: 'dash',
      DNT: 'district0x',
      ENG: 'enigma-project',
      ETC: 'ethereum-classic',
      ETH: 'ethereum',
      FUN: 'funfair',
      KMD: 'komodo',
      LSK: 'lisk',
      LTC: 'litecoin',
      LUN: 'lunyr',
      MANA: 'decentraland',
      MCO: 'monaco',
      NAV: 'nav-coin',
      NEO: 'neo',
      OMG: 'omisego',
      POWR: 'power-ledger',
      QTUM: 'qtum',
      RCN: 'ripio-credit-network',
      RLC: 'rlc',
      SALT: 'salt',
      SNT: 'status',
      STORJ: 'storj',
      STRAT: 'stratis',
      VIB: 'viberate',
      WAVES: 'waves',
      WINGS: 'wings',
      XLM: 'stellar',
      XMR: 'monero',
      XRP: 'ripple',
      XVG: 'verge',
      XZC: 'zcoin',
      ZEC: 'zcash'
    };

    const BINANCE = CRYPTO.filter(currency => currency != 'RLC');

    const CRYPTOCOMPARE = { BCH: 'BCC' };

    const table = document.querySelector('.crypto');

    CRYPTO.forEach(currency => {
      const row = document.createElement('tr');

      row.classList.add(currency);

      const exchangeName = CRYPTOCOMPARE[currency] ? CRYPTOCOMPARE[currency] : currency;

      row.innerHTML = `
        <td class="currency"><a target="_blank" href="https://coinmarketcap.com/currencies/${COINMARKETCAP[currency]}">${currency}</a></td>
        <td class="bittrex"><a target="_blank" href="https://bittrex.com/Market/Index?MarketName=BTC-${exchangeName}"></a></td>
        <td class="binance"><a target="_blank" href="https://www.binance.com/trade.html?symbol=${exchangeName}_BTC"></a></td>
        <td class="binance-change"></td>
        <td class="coinbase"><a target="_blank" href="https://www.gdax.com/trade/${currency}-BTC"></a></td>
        <td class="difference"></td>
      `;

      table.appendChild(row);
    });

    function getCoinbasePrices() {
      const exchangePrices = CRYPTO.reduce((prices, currency) => {
        prices[currency] = {};

        return prices;
      }, {});

      Promise.all([
        fetch(`https://api.gdax.com/products/BTC-USD/ticker`)
          .then(response => response.json())
          .then(({ price }) => {
            document.querySelector(`.BTC-USD .price`).textContent = `$${price}`;

            exchangePrices.BTC = price;
          }),
        fetch(`https://api.gdax.com/products/BCH-USD/ticker`)
          .then(response => response.json())
          .then(({ price }) => {
            document.querySelector(`.BCH-USD .price`).textContent = `$${price}`;

            exchangePrices.BCH.USD = price;
          }),
        fetch(`https://api.gdax.com/products/ETH-BTC/ticker`)
          .then(response => response.json())
          .then(({ price }) => {
            const entry = document.querySelector(`.ETH .coinbase a`);

            entry.textContent = price;
            exchangePrices.ETH.coinbase = price;
          }),
        fetch(`https://api.gdax.com/products/LTC-BTC/ticker`)
          .then(response => response.json())
          .then(({ price }) => {
            const entry = document.querySelector(`.LTC .coinbase a`);

            entry.textContent = price;
            exchangePrices.LTC.coinbase = price;
          })
      ]).then(() => {
        const coinbaseBCHBTC = (exchangePrices.BCH.USD / exchangePrices.BTC).toFixed(8);

        exchangePrices.BCH.coinbase = coinbaseBCHBTC;

        document.querySelector(`.BCH .coinbase a`).textContent = coinbaseBCHBTC;

        setTimeout(getCoinbasePrices, 750);
      }).catch(() => {
        setTimeout(getCoinbasePrices, 1500);
      });
    }

    function getPrices() {
      const exchangePrices = CRYPTO.reduce((prices, currency) => {
        prices[currency] = {};

        return prices;
      }, {});

      Promise.all([
        // fetch(`https://min-api.cryptocompare.com/data/pricemultifull?fsyms=${CRYPTO.join()}&tsyms=BTC&e=Bittrex`)
          // .then(response => response.json())
          // .then(({ RAW: prices }) => {
            // CRYPTO.forEach(currency => {
              // const entry = document.querySelector(`.${currency} .bittrex a`);
              // const price = prices[currency].BTC.PRICE;
              // const change = prices[currency].BTC.CHANGEPCT24HOUR;

              // entry.textContent = price;
              // exchangePrices[currency].bittrex = price;

              // const changeEntry = document.querySelector(`.${currency} .bittrex-change`);

              // changeEntry.classList.remove('gain', 'loss');
              // changeEntry.classList.add(change > 0 ? 'gain' : 'loss');

              // changeEntry.textContent = `${change.toFixed(2)}%`;
            // });
          // }),
        fetch('http://crypto-191318.appspot.com/crypto?arbitrage=true')
          .then(response => response.json())
          .then(({ bittrexPrices, bittrexWallets, binancePrices, binanceOrders }) => {
            CRYPTO.forEach(currency => {
              const exchangeName = CRYPTOCOMPARE[currency] ? CRYPTOCOMPARE[currency] : currency;

              const bittrexEntry = document.querySelector(`.${currency} .bittrex a`);
              const bittrexPrice = bittrexPrices[exchangeName].last;

              bittrexEntry.textContent = bittrexPrice;
              exchangePrices[currency].bittrex = bittrexPrice;

              const binanceEntry = document.querySelector(`.${currency} .binance a`);
              const binancePrice = Number(binancePrices[exchangeName]);

              binanceEntry.textContent = binancePrice;
              exchangePrices[currency].binance = binancePrice;
            });
          }),
        fetch(`https://min-api.cryptocompare.com/data/pricemultifull?fsyms=${BINANCE.join()}&tsyms=BTC&e=Binance`)
          .then(response => response.json())
          .then(({ RAW: prices }) => {
            BINANCE.forEach(currency => {
              const entry = document.querySelector(`.${currency} .binance a`);
              // const price = prices[currency].BTC.PRICE;
              const change = prices[currency].BTC.CHANGEPCT24HOUR;

              // entry.textContent = price;
              // exchangePrices[currency].binance = price;

              const changeEntry = document.querySelector(`.${currency} .binance-change`);

              changeEntry.classList.remove('gain', 'loss');
              changeEntry.classList.add(change > 0 ? 'gain' : 'loss');

              changeEntry.textContent = `${change.toFixed(2)}%`;
            });
          })
      ]).then(() => {
        CRYPTO.forEach(currency => {
          const bittrex = exchangePrices[currency].bittrex;
          const binance = exchangePrices[currency].binance;

          if (!bittrex || !binance) return;

          const bittrexEntry = document.querySelector(`.${currency} .bittrex a`);
          const binanceEntry = document.querySelector(`.${currency} .binance a`);

          [bittrexEntry, binanceEntry].forEach(entry => entry.classList.remove('higher', 'lower'));

          const difference = bittrex - binance;

          if (difference > 0) {
            bittrexEntry.classList.add('higher');
            binanceEntry.classList.add('lower');
          } else {
            bittrexEntry.classList.add('lower');
            binanceEntry.classList.add('higher');
          }

          const entry = document.querySelector(`.${currency} .difference`);

          const percentage = Math.abs(difference)/Math.min(bittrex, binance) * 100;

          entry.textContent = `${percentage.toFixed(2)}%`;

          entry.classList.remove('levelOne', 'levelTwo', 'levelThree');

          if (percentage > 4.5) {
            entry.classList.add('levelThree');
          } else if (percentage > 3) {
            entry.classList.add('levelTwo');
          } else if (percentage > 1) {
            entry.classList.add('levelOne');
          }
        });

        document.querySelector('.last-updated .time').textContent = new Date();

        setTimeout(getPrices, 750);
      }).catch(() => {
        setTimeout(getPrices, 1500);
      });
    }

    getCoinbasePrices();
    getPrices();
  </script>
</body>
</html>
